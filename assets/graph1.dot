digraph TerraformArchitecture {
  // Set overall graph attributes
  rankdir=LR;
  splines=true;
  nodesep=0.8;
  ranksep=1.0;
  labelloc="t";
  label="Terraform Architecture Overview";

  // Default node style
  node [shape=rect, style=filled, fontname="sans-serif", fontsize=10, fillcolor=white];

  // Default edge style
  edge [fontname="sans-serif", fontsize=9, color=gray30];

  // Data Bucket Node
  "data.aws_s3_bucket.s3" [label="data.aws_s3_bucket.s3", fillcolor="#FFD700"];

  // Module: ALB (Application Load Balancer)
  subgraph cluster_module_alb {
    label="module.alb (ALB & Listeners)";
    style=filled;
    color="#AED6F1";
    node [fillcolor=white];
    "module.alb.aws_lb.main" [label="aws_lb.main"];
    "module.alb.aws_lb_listener.http" [label="aws_lb_listener.http"];
    "module.alb.aws_lb_listener.https" [label="aws_lb_listener.https"];
    "module.alb.aws_lb_target_group.main" [label="aws_lb_target_group.main"];
  }

  // Module: ASG (Auto Scaling Group)
  subgraph cluster_module_asg {
    label="module.asg (Auto Scaling & Launch Templates)";
    style=filled;
    color="#A9DFBF";
    node [fillcolor=white];
    "module.asg.data.aws_ami.amazon_linux_2_free_tier" [label="data.aws_ami.amazon_linux_2_free_tier"];
    "module.asg.data.template_file.nginx_userdata" [label="data.template_file.nginx_userdata"];
    "module.asg.aws_autoscaling_group.nginx_web_asg" [label="aws_autoscaling_group.nginx_web_asg"];
    "module.asg.aws_autoscaling_policy.scale_in" [label="aws_autoscaling_policy.scale_in"];
    "module.asg.aws_autoscaling_policy.scaling_out" [label="aws_autoscaling_policy.scaling_out"];
    "module.asg.aws_cloudwatch_metric_alarm.cpu_high" [label="aws_cloudwatch_metric_alarm.cpu_high"];
    "module.asg.aws_cloudwatch_metric_alarm.cpu_low" [label="aws_cloudwatch_metric_alarm.cpu_low"];
    "module.asg.aws_key_pair.my_key" [label="aws_key_pair.my_key"];
    "module.asg.aws_launch_template.nginx_web_lt" [label="aws_launch_template.nginx_web_lt"];
  }

  // Module: Bastion
  subgraph cluster_module_bastion {
    label="module.bastion (Bastion Host)";
    style=filled;
    color="#F9E79F";
    node [fillcolor=white];
    "module.bastion.data.aws_ami.amazon_linux_2_free_tier" [label="data.aws_ami.amazon_linux_2_free_tier"];
    "module.bastion.aws_instance.bastion" [label="aws_instance.bastion"];
    "module.bastion.aws_security_group.bastion_sg" [label="aws_security_group.bastion_sg"];
  }

  // Module: RDS
  subgraph cluster_module_rds {
    label="module.rds (RDS)";
    style=filled;
    color="#F5B7B1";
    node [fillcolor=white];
    "module.rds.aws_db_instance.default" [label="aws_db_instance.default"];
    "module.rds.aws_db_subnet_group.default" [label="aws_db_subnet_group.default"];
  }

  // Module: Security
  subgraph cluster_module_security {
    label="module.security (IAM & Bucket Policies)";
    style=filled;
    color="#D7BDE2";
    node [fillcolor=white];
    "module.security.aws_iam_instance_profile.ec2_profile" [label="aws_iam_instance_profile.ec2_profile"];
    "module.security.aws_iam_policy.ec2_policy" [label="aws_iam_policy.ec2_policy"];
    "module.security.aws_iam_role.ec2_role" [label="aws_iam_role.ec2_role"];
    "module.security.aws_iam_role_policy_attachment.ec2_policy_attachment" [label="aws_iam_role_policy_attachment.ec2_policy_attachment"];
    "module.security.aws_s3_bucket_policy.alb_logs_policy" [label="aws_s3_bucket_policy.alb_logs_policy"];
  }

  // Module: VPC & Networking
  subgraph cluster_module_vpc {
    label="module.vpc (Networking)";
    style=filled;
    color="#FAD7A0";
    node [fillcolor=white];
    "module.vpc.aws_eip.nat_eip" [label="aws_eip.nat_eip"];
    "module.vpc.aws_internet_gateway.igw" [label="aws_internet_gateway.igw"];
    "module.vpc.aws_nat_gateway.nat" [label="aws_nat_gateway.nat"];
    "module.vpc.aws_route_table.private_rt" [label="aws_route_table.private_rt"];
    "module.vpc.aws_route_table.public_rt" [label="aws_route_table.public_rt"];
    "module.vpc.aws_route_table_association.private_association" [label="aws_route_table_association.private_association"];
    "module.vpc.aws_route_table_association.public_association" [label="aws_route_table_association.public_association"];
    "module.vpc.aws_security_group.alb_sg" [label="aws_security_group.alb_sg"];
    "module.vpc.aws_security_group.ec2_sg" [label="aws_security_group.ec2_sg"];
    "module.vpc.aws_security_group.rds_sg" [label="aws_security_group.rds_sg"];
    "module.vpc.aws_subnet.private" [label="aws_subnet.private"];
    "module.vpc.aws_subnet.public" [label="aws_subnet.public"];
    "module.vpc.aws_vpc.main" [label="aws_vpc.main"];
  }

  // -------------------- Edges with Descriptive Labels --------------------

  // ALB -> S3 bucket (Access logs)
  "module.alb.aws_lb.main" -> "data.aws_s3_bucket.s3" [label="configures access_logs", color=blue];

  // ALB -> VPC Security Group & Subnets
  "module.alb.aws_lb.main" -> "module.vpc.aws_security_group.alb_sg" [label="attached security group", color=blue];
  "module.alb.aws_lb.main" -> "module.vpc.aws_subnet.public" [label="placed in public subnet", color=blue];

  // Listeners use the ALB and target group
  "module.alb.aws_lb_listener.http" -> "module.alb.aws_lb.main" [label="listens on HTTP", color=darkgreen];
  "module.alb.aws_lb_listener.http" -> "module.alb.aws_lb_target_group.main" [label="routes traffic", color=darkgreen];
  "module.alb.aws_lb_listener.https" -> "module.alb.aws_lb.main" [label="listens on HTTPS", color=darkgreen];
  "module.alb.aws_lb_listener.https" -> "module.alb.aws_lb_target_group.main" [label="routes traffic", color=darkgreen];

  // Target group dependency on VPC
  "module.alb.aws_lb_target_group.main" -> "module.vpc.aws_vpc.main" [label="VPC association", color=purple];

  // ASG: UserData depends on S3 Bucket for templates
  "module.asg.data.template_file.nginx_userdata" -> "data.aws_s3_bucket.s3" [label="fetches userdata script", color=orange];

  // ASG connects to Target Group and Launch Template
  "module.asg.aws_autoscaling_group.nginx_web_asg" -> "module.alb.aws_lb_target_group.main" [label="registered as targets", color=red];
  "module.asg.aws_autoscaling_group.nginx_web_asg" -> "module.asg.aws_launch_template.nginx_web_lt" [label="launch config", color=red];
  "module.asg.aws_autoscaling_group.nginx_web_asg" -> "module.vpc.aws_subnet.private" [label="in private subnet", color=red];

  // ASG policies and alarms linked to ASG
  "module.asg.aws_autoscaling_policy.scale_in" -> "module.asg.aws_autoscaling_group.nginx_web_asg" [label="scale in", color=brown];
  "module.asg.aws_autoscaling_policy.scaling_out" -> "module.asg.aws_autoscaling_group.nginx_web_asg" [label="scale out", color=brown];
  "module.asg.aws_cloudwatch_metric_alarm.cpu_high" -> "module.asg.aws_autoscaling_policy.scaling_out" [label="triggers scale out", color=brown];
  "module.asg.aws_cloudwatch_metric_alarm.cpu_low" -> "module.asg.aws_autoscaling_policy.scale_in" [label="triggers scale in", color=brown];

  // ASG Launch Template dependencies
  "module.asg.aws_launch_template.nginx_web_lt" -> "module.asg.data.aws_ami.amazon_linux_2_free_tier" [label="uses AMI", color=teal];
  "module.asg.aws_launch_template.nginx_web_lt" -> "module.asg.data.template_file.nginx_userdata" [label="includes userdata", color=teal];
  "module.asg.aws_launch_template.nginx_web_lt" -> "module.asg.aws_key_pair.my_key" [label="uses key pair", color=teal];
  "module.asg.aws_launch_template.nginx_web_lt" -> "module.security.aws_iam_instance_profile.ec2_profile" [label="attached IAM profile", color=teal];
  "module.asg.aws_launch_template.nginx_web_lt" -> "module.vpc.aws_security_group.ec2_sg" [label="attached security group", color=teal];

  // Bastion connections
  "module.bastion.aws_instance.bastion" -> "module.asg.aws_key_pair.my_key" [label="uses key pair", color=maroon];
  "module.bastion.aws_instance.bastion" -> "module.bastion.data.aws_ami.amazon_linux_2_free_tier" [label="uses AMI", color=maroon];
  "module.bastion.aws_instance.bastion" -> "module.bastion.aws_security_group.bastion_sg" [label="attached SG", color=maroon];
  "module.bastion.aws_instance.bastion" -> "module.vpc.aws_subnet.public" [label="in public subnet", color=maroon];

  // Bastion SG depends on VPC
  "module.bastion.aws_security_group.bastion_sg" -> "module.vpc.aws_vpc.main" [label="VPC association", color=maroon];

  // RDS dependencies
  "module.rds.aws_db_instance.default" -> "module.rds.aws_db_subnet_group.default" [label="uses subnet group", color=darkorange];
  "module.rds.aws_db_instance.default" -> "module.vpc.aws_security_group.rds_sg" [label="attached security group", color=darkorange];
  "module.rds.aws_db_subnet_group.default" -> "module.vpc.aws_subnet.private" [label="in private subnet", color=darkorange];

  // Security module dependencies
  "module.security.aws_iam_instance_profile.ec2_profile" -> "module.security.aws_iam_role.ec2_role" [label="IAM profile trusts role", color=violet];
  "module.security.aws_iam_policy.ec2_policy" -> "data.aws_s3_bucket.s3" [label="policy grants S3 read", color=violet];
  "module.security.aws_iam_role_policy_attachment.ec2_policy_attachment" -> "module.security.aws_iam_policy.ec2_policy" [label="attaches policy", color=violet];
  "module.security.aws_iam_role_policy_attachment.ec2_policy_attachment" -> "module.security.aws_iam_role.ec2_role" [label="attaches to role", color=violet];
  "module.security.aws_s3_bucket_policy.alb_logs_policy" -> "data.aws_s3_bucket.s3" [label="controls ALB log writes", color=violet];

  // VPC & Networking dependencies
  "module.vpc.aws_internet_gateway.igw" -> "module.vpc.aws_vpc.main" [label="IGW for VPC", color=gray];
  "module.vpc.aws_nat_gateway.nat" -> "module.vpc.aws_eip.nat_eip" [label="associated EIP", color=gray];
  "module.vpc.aws_nat_gateway.nat" -> "module.vpc.aws_subnet.public" [label="in public subnet", color=gray];
  "module.vpc.aws_route_table.private_rt" -> "module.vpc.aws_nat_gateway.nat" [label="routes private traffic", color=gray];
  "module.vpc.aws_route_table.public_rt" -> "module.vpc.aws_internet_gateway.igw" [label="routes public traffic", color=gray];
  "module.vpc.aws_route_table_association.private_association" -> "module.vpc.aws_route_table.private_rt" [label="associates private subnet", color=gray];
  "module.vpc.aws_route_table_association.private_association" -> "module.vpc.aws_subnet.private" [label="private subnet", color=gray];
  "module.vpc.aws_route_table_association.public_association" -> "module.vpc.aws_route_table.public_rt" [label="associates public subnet", color=gray];
  "module.vpc.aws_route_table_association.public_association" -> "module.vpc.aws_subnet.public" [label="public subnet", color=gray];
  "module.vpc.aws_security_group.alb_sg" -> "module.vpc.aws_vpc.main" [label="SG in VPC", color=gray];
  "module.vpc.aws_security_group.ec2_sg" -> "module.vpc.aws_security_group.alb_sg" [label="depends on ALB SG", color=gray];
  "module.vpc.aws_security_group.rds_sg" -> "module.vpc.aws_security_group.ec2_sg" [label="SG chain", color=gray];
  "module.vpc.aws_subnet.private" -> "module.vpc.aws_vpc.main" [label="belongs to VPC", color=gray];
  "module.vpc.aws_subnet.public" -> "module.vpc.aws_vpc.main" [label="belongs to VPC", color=gray];
}
