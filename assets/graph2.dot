digraph ProjectStructure {
  rankdir=LR;
  splines=ortho;
  concentrate=true;
  node [shape=box, style=filled, fontname="Helvetica", fontsize=10];
  edge [fontname="Helvetica", fontsize=9];

  // Global Nodes
  "S3 Bucket" [label="S3 Bucket\n(data.aws_s3_bucket.s3)", fillcolor=lightyellow];
  "Jenkins UserData" [label="Jenkins UserData\n(data.template_file.jenkins_userdata)", fillcolor=lightyellow];

  // VPC Module Cluster
  subgraph cluster_vpc {
    label="Module: VPC";
    style=filled;
    fillcolor="#C8E6C9";
    "VPC" [label="VPC\n(module.vpc)"];
  }

  // Security Module Cluster
  subgraph cluster_security {
    label="Module: Security";
    style=filled;
    fillcolor="#F5E1D7";
    "Security" [label="Security\n(module.security)"];
  }

  // Nginx ALB Module Cluster
  subgraph cluster_alb {
    label="Module: Nginx ALB";
    style=filled;
    fillcolor="#FFE0B2";
    "Nginx ALB" [label="Nginx ALB\n(module.nginx_alb)"];
  }

  // Nginx ASG Module Cluster
  subgraph cluster_asg {
    label="Module: Nginx ASG";
    style=filled;
    fillcolor="#E1BEE7";
    "Nginx ASG" [label="Nginx ASG\n(module.nginx_asg)"];
    "Key Pair" [label="Key Pair\n(module.nginx_asg.key_pair_name)", shape=ellipse, fillcolor=white];
  }

  // RDS Module Cluster
  subgraph cluster_rds {
    label="Module: RDS";
    style=filled;
    fillcolor="#FFCDD2";
    "RDS" [label="RDS\n(module.rds)"];
  }

  // Bastion Module Cluster
  subgraph cluster_bastion {
    label="Module: Bastion";
    style=filled;
    fillcolor="#CCECFF";
    "Bastion" [label="Bastion\n(module.bastion)"];
  }

  // Jenkins Module Cluster
  subgraph cluster_jenkins {
    label="Module: Jenkins";
    style=filled;
    fillcolor="#CCFFCC";
    "Jenkins" [label="Jenkins\n(module.jenkins)"];
  }

  // ---- Edges describing dependencies ----

  // VPC outputs connect to several modules
  "VPC" -> "Nginx ALB" [label="vpc_id, public_subnets, alb_sg", color=darkgreen];
  "VPC" -> "Nginx ASG" [label="private_subnets", color=darkgreen];
  "VPC" -> "RDS" [label="private_subnets", color=darkgreen];
  "VPC" -> "Bastion" [label="public_subnet (first)", color=darkgreen];
  "VPC" -> "Jenkins" [label="public_subnet (first)", color=darkgreen];
  "VPC" -> "Security" [label="sg IDs: alb, bastion, jenkins, rds", color=darkgreen];

  // S3 bucket data flows
  "S3 Bucket" -> "Nginx ALB" [label="alb_log_bucket", color=orange];
  "S3 Bucket" -> "Security" [label="s3_bucket_arn/id", color=orange];

  // ALB target group ARN flows into ASG
  "Nginx ALB" -> "Nginx ASG" [label="target_group_arn", color=purple];

  // Security module provides instance profile for ASG
  "Security" -> "Nginx ASG" [label="instance profile", color=brown];

  // ASG Key Pair is used by Bastion and Jenkins
  "Key Pair" -> "Bastion" [label="key_name", color=blue];
  "Key Pair" -> "Jenkins" [label="key_name", color=blue];

  // Jenkins uses user data
  "Jenkins UserData" -> "Jenkins" [label="base64encoded_user_data", color=green];
}
